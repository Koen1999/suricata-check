# Below we will put an empty line

# Next we will put an empty comment
#

# Below we put a rule for which no clear direction is set and several variations of it with comments and whitespace
alert ip any any -> any any (msg:"Test"; sid:1;)
 alert ip any any -> any any (msg:"Test"; sid:1;)
alert ip any any -> any any (msg:"Test"; sid:1;) 
#alert ip any any -> any any (msg:"Test"; sid:1;)
# alert ip any any -> any any (msg:"Test"; sid:1;)
 # alert ip any any -> any any (msg:"Test"; sid:1;)

####################################################################################################
# Next we put a bunch of rules that I developed to check for more arbitrary errors
####################################################################################################

# TLS rules

# These rules detect common SNI behavior and set Xbits
alert tls any any -> $HTTP_SERVERS 443 (msg:"KOEN INFO HTTPS (HTTP/TLS) Server commonly uses domain name as Server Name Indication (SNI)"; flow:established,to_server; tls.sni; pcre:"/([a-zA-Z\d\-]+\.)+[a-zA-Z\d\-]+/"; xbits:isnotset,koen_supports_sni,track ip_dst; xbits:set,koen_supports_sni_domain,track ip_dst; noalert; threshold:type both,track by_dst,count 5,seconds 86400; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-activity; priority:3; gid:1999; sid:1999000; rev:1; metadata:affected_product Any, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Informational;)
alert tls any any -> $HTTP_SERVERS 443 (msg:"KOEN INFO HTTPS (HTTP/TLS) Server commonly uses Internet Protocol version 4 (IPv4) address as Server Name Indication (SNI)"; flow:established,to_server; tls.sni; pcre:"/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/"; xbits:isnotset,koen_supports_sni,track ip_dst; xbits:set,koen_supports_sni_ipv4,track ip_dst; threshold:type both,track by_dst,count 5,seconds 86400; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-activity; priority:3; gid:1999; sid:1999001; rev:1; metadata:affected_product Any, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Informational;)
alert tls any any -> $HTTP_SERVERS 443 (msg:"KOEN INFO HTTPS (HTTP/TLS) Server commonly uses Server Name Indication (SNI)"; flow:established,to_server; tls.sni; bsize:>0; xbits:set,koen_supports_sni,track ip_dst; noalert; threshold:type both,track by_dst,count 15,seconds 86400; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-activity; priority:3; gid:1999; sid:1999002; rev:1; metadata:affected_product Any, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Informational;)

# Before this rule will work, it first requires a PR to be merged, which will be released with Suricata 8.0.0 (BETA)
# https://github.com/OISF/suricata/pull/10462
# https://redmine.openinfosecfoundation.org/issues/2224
# alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING HTTPS (HTTP/TLS) without Server Name Indication (SNI) while domain name was expected as SNI"; flow:established,to_server; tls.sni; absent; xbits:isset,koen_supports_sni_domain,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:3; gid:1999; sid:1999010; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor; requires: version >= 8;)

# These rules detect SNI not present
# Based on https://idpsystems.org/blog/how_to_fly_under_the_radar_of_internet_mass_scanners
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello without Server Name Indication (SNI) while domain name was expected"; flow:established,to_server; content:"|16 03|"; depth:2; content:"|01|"; distance:3; within:1; byte_jump:1, 37, relative, big; byte_jump:2, 0, relative, big; byte_jump:1, 0, relative, big; byte_extract:2, 0, ext_len, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; xbits:isset,koen_supports_sni,track ip_dst; xbits:isset,koen_supports_sni_domain,track ip_dst; xbits:isnotset,koen_supports_sni_ipv4,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999010; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello without Server Name Indication (SNI) while Internet Protocol version 4 (IPv4) address was expected as SNI"; flow:established,to_server; content:"|16 03|"; depth:2; content:"|01|"; distance:3; within:1; byte_jump:1, 37, relative, big; byte_jump:2, 0, relative, big; byte_jump:1, 0, relative, big; byte_extract:2, 0, ext_len, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; xbits:isset,koen_supports_sni,track ip_dst; xbits:isset,koen_supports_sni_ipv4,track ip_dst; xbits:isnotset,koen_supports_sni_domain,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999011; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello without Server Name Indication (SNI)"; flow:established,to_server; content:"|16 03|"; depth:2; content:"|01|"; distance:3; within:1; byte_jump:1, 37, relative, big; byte_jump:2, 0, relative, big; byte_jump:1, 0, relative, big; byte_extract:2, 0, ext_len, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; content:!"|00 00|"; distance:0; within:2; isdataat:1, relative; byte_jump:2, 2, relative, big; xbits:isset,koen_supports_sni,track ip_dst; xbits:isnotset,koen_supports_sni_domain,track ip_dst; xbits:isnotset,koen_supports_sni_ipv4,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999012; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)

# These rules detect Domain name vs. IPv4 as SNI
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello with Internet Protocol version 4 (IPv4) address as Server Name Indication (SNI) while domain name was expected as SNI"; flow:established,to_server; tls.sni; pcre:"/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/"; xbits:isset,koen_supports_sni,track ip_dst; xbits:isset,koen_supports_sni_domain,track ip_dst; xbits:isnotset,koen_supports_sni_ipv4,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999020; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello with domain name as Server Name Indication (SNI) while Internet Protocol version 4 (IPv4) address was expected as SNI"; flow:established,to_server; tls.sni; pcre:"/([a-zA-Z\d\-]+\.)+[a-zA-Z\d\-]+/"; xbits:isset,koen_supports_sni,track ip_dst; xbits:isset,koen_supports_sni_ipv4,track ip_dst; xbits:isnotset,koen_supports_sni_domain,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999021; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)

# These rules detect Unparseable SNI
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello with unexpected as Server Name Indication (SNI) while Internet Protocol version 4 (IPv4) address was expected as SNI"; flow:established,to_server; tls.sni; pcre:!"/([a-zA-Z\d\-]+\.)+[a-zA-Z\d\-]+/"; pcre:!"/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/"; xbits:isset,koen_supports_sni_ipv4,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999030; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tls $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTPS (HTTP/TLS) Client Hello with unexpected as Server Name Indication (SNI) while domain name was expected as SNI"; flow:established,to_server; tls.sni; pcre:!"/([a-zA-Z\d\-]+\.)+[a-zA-Z\d\-]+/"; pcre:!"/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/"; xbits:isset,koen_supports_sni_domain,track ip_dst; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999031; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)

# These rules detect TLS Alerts
alert tls $HOME_NET any -> $EXTERNAL_NET any (msg:"KOEN INFO Outbound TLS Fatal Alert due to Unsupported Protocol Version"; flow:established,to_client; content:"|15|"; offset:0; depth:1; content:"|02 46|"; distance:4; threshold:type both,track by_both,count 1,seconds 3600; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-activity; priority:3; gid:1999; sid:1999040; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Informational;)
alert tls $HOME_NET any -> $EXTERNAL_NET any (msg:"KOEN HUNTING Outbound TLS Fatal Alert due to Illegal Parameter"; flow:established,to_client; content:"|15|"; offset:0; depth:1; content:"|02 2f|"; distance:4; threshold:type both,track by_both,count 1,seconds 3600; target:src_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-attack; priority:2; gid:1999; sid:1999041; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tls $HOME_NET any -> $EXTERNAL_NET any (msg:"KOEN HUNTING Outbound TLS Fatal Alert due to Handshake Failure"; flow:established,to_client; content:"|15|"; offset:0; depth:1; content:"|02 28|"; distance:4; threshold:type both,track by_both,count 1,seconds 3600; target:src_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-activity; priority:3; gid:1999; sid:1999042; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Informational;)

# These rules detect weak TLS versions
alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"KOEN HUNTING Inbound TLS Client Hello supporting TLS 1.0"; flow:established,to_server; content:"|16|"; offset:0; depth:1; content:"|01|"; distance:4; within:1; content:"|00 2b|"; distance:0; content:"|03 01|"; distance:3; within:8; threshold:type both,track by_src,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:misc-attack; priority:3; gid:1999; sid:1999050; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Informational;)
alert tls $HOME_NET any -> any any (msg:"KOEN POLICY Internal Host sending TLS Client Hello supporting TLS 1.0"; flow:established,to_server; content:"|16|"; offset:0; depth:1; content:"|01|"; distance:4; within:1; content:"|00 2b|"; distance:0; content:"|03 01|"; distance:3; within:8; threshold:type both,track by_src,count 1,seconds 3600; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:policy-violation; priority:3; gid:1999; sid:1999051; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Policy;)
alert tls $HOME_NET any -> any any (msg:"KOEN POLICY Internal Host sending TLS Client Hello supporting TLS 1.1"; flow:established,to_server; content:"|16|"; offset:0; depth:1; content:"|01|"; distance:4; within:1; content:"|00 2b|"; distance:0; content:"|03 02|"; distance:3; within:8; threshold:type both,track by_src,count 1,seconds 3600; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:policy-violation; priority:3; gid:1999; sid:1999052; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Policy;)
alert tls $HOME_NET any -> any any (msg:"KOEN POLICY Internal Server sending TLS Server Hello supporting TLS 1.0"; flow:established,to_client; content:"|16|"; offset:0; depth:1; content:"|02|"; distance:4; within:1; content:"|00 2b|"; distance:0; content:"|03 01|"; distance:3; within:8; threshold:type both,track by_src,count 1,seconds 3600; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:web-application-activity; priority:2; gid:1999; sid:1999053; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Policy;)
alert tls $HOME_NET any -> any any (msg:"KOEN POLICY Internal Server sending TLS Server Hello supporting TLS 1.1"; flow:established,to_client; content:"|16|"; offset:0; depth:1; content:"|02|"; distance:4; within:1; content:"|00 2b|"; distance:0; content:"|03 02|"; distance:3; within:8; threshold:type both,track by_src,count 1,seconds 3600; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:web-application-activity; priority:2; gid:1999; sid:1999054; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Policy;)

# These rules detect HTTP traffic on HTTPS ports
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS 443 (msg:"KOEN HUNTING Inbound HTTP Request over HTTPS (HTTP/TLS) port"; flow:established,to_server; pcre:"/^(GET|HEAD|POST|PUT|DELETE|CONNECT|OPTIONS|TRACE|PATCH)\s[a-zA-Z0-9\.\/\?\&\=\_\~\#\:]+\sHTTP/[\d](\.[\d])?\s\n/"; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999060; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tcp $HTTP_SERVERS 443 -> $EXTERNAL_NET any (msg:"KOEN HUNTING Outbound HTTP Response over HTTPS (HTTP/TLS) port"; flow:established,to_client; content:"HTTP"; offset:0; depth:4; pcre:"/^HTTP/[\d](\.[\d])?\s\d{3}[\s\w]+\s\n/"; threshold:type both,track by_both,count 1,seconds 3600; target:src_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:non-standard-protocol; priority:2; gid:1999; sid:1999061; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Minor;)
alert tcp $HOME_NET any -> $EXTERNAL_NET 443 (msg:"KOEN C2 Outbound HTTP Request over HTTPS (HTTP/TLS) port"; flow:established,to_server; pcre:"/^(GET|HEAD|POST|PUT|DELETE|CONNECT|OPTIONS|TRACE|PATCH)\s[a-zA-Z0-9\.\/\?\&\=\_\~\#\:]+\sHTTP/[\d](\.[\d])?\s\n/"; threshold:type both,track by_both,count 1,seconds 3600; target:src_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:command-and-control; priority:1; gid:1999; sid:1999062; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Major;)
alert tcp $EXTERNAL_NET 443 -> $HOME_NET any (msg:"KOEN C2 Inbound HTTP Response over HTTPS (HTTP/TLS) port"; flow:established,to_client; content:"HTTP"; offset:0; depth:4; pcre:"/^HTTP/[\d](\.[\d])?\s\d{3}[\s\w]+\s\n/"; threshold:type both,track by_both,count 1,seconds 3600; target:dest_ip; reference:url,koen.teuwen.net/report/tls-web-attack-detection; classtype:command-and-control; priority:1; gid:1999; sid:1999063; rev:1; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2024_03_06, deployment Perimeter, performance_impact Low, signature_severity Major;)

####################################################################################################
# Next we put a bunch of rules that I know caused errors at some point but are valid rules
####################################################################################################

alert dns any any -> any any (msg : "contains dns to detectme.foobar"; content : "detectme.foobar"; sid: 1;)

alert dns any any -> any any ( \
    msg:"contains dns to detectme.foobar"; \
    content:"detectme.foobar"; \
    sid:1; \
)
